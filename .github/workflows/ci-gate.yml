# Orchestrates all PR CI by detecting changed paths and conditionally invoking
# per-language workflows. The "gate" job always runs and can be configured as
# the single required status check in GitHub branch protection.
name: CI Gate

permissions: {}

on:
  pull_request:
  workflow_dispatch:

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      java-hibernate: ${{ steps.detect.outputs.java-hibernate }}
      node-prisma: ${{ steps.detect.outputs.node-prisma }}
      python-django: ${{ steps.detect.outputs.python-django }}
      python-sqlalchemy: ${{ steps.detect.outputs.python-sqlalchemy }}
      python-tortoise: ${{ steps.detect.outputs.python-tortoise }}
    steps:
      - uses: actions/github-script@v7
        id: detect
        with:
          script: |
            const config = {
              'java-hibernate': ['java/hibernate/', '.github/workflows/java-hibernate-ci.yml'],
              'node-prisma': ['node/prisma/', '.github/workflows/node-prisma-ci.yml'],
              'python-django': ['python/django/', '.github/workflows/python-django-ci.yml'],
              'python-sqlalchemy': ['python/sqlalchemy/', '.github/workflows/python-sqlalchemy-ci.yml'],
              'python-tortoise': ['python/tortoise-orm/', '.github/workflows/python-tortoise-ci.yml'],
            };
            const runAllPaths = [
              '.github/workflows/ci-gate.yml',
              '.github/workflows/dsql-cluster-create.yml',
              '.github/workflows/dsql-cluster-delete.yml',
              '.pre-commit-config.yaml',
              'pyproject.toml'
            ];

            const pr = context.payload.pull_request;

            // Manual dispatch: run all CI
            if (!pr) {
              for (const name of Object.keys(config)) {
                core.setOutput(name, 'true');
              }
              return;
            }

            let files = [];
            const paginator = github.paginate.iterator(github.rest.pulls.listFiles, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              per_page: 100,
            });
            for await (const resp of paginator) {
              files.push(...resp.data.map(f => f.filename));
            }

            // If API truncated results, run everything to be safe
            let runAll = files.length < pr.changed_files;

            if (!runAll) {
              runAll = files.some(f => runAllPaths.some(p => f === p || f.startsWith(p)));
            }

            for (const [name, paths] of Object.entries(config)) {
              const shouldRun = runAll || files.some(f => paths.some(p => f.startsWith(p)));
              core.setOutput(name, String(shouldRun));
            }

  pre-commit:
    needs: changes
    uses: ./.github/workflows/pre-commit.yml

  java-hibernate:
    needs: changes
    if: needs.changes.outputs.java-hibernate == 'true'
    uses: ./.github/workflows/java-hibernate-ci.yml
    secrets: inherit
    permissions:
      id-token: write # required by aws-actions/configure-aws-credentials

  node-prisma:
    needs: changes
    if: needs.changes.outputs.node-prisma == 'true'
    uses: ./.github/workflows/node-prisma-ci.yml
    secrets: inherit
    permissions:
      id-token: write # required by aws-actions/configure-aws-credentials

  python-django:
    needs: changes
    if: needs.changes.outputs.python-django == 'true'
    uses: ./.github/workflows/python-django-ci.yml
    secrets: inherit
    permissions:
      id-token: write # required by aws-actions/configure-aws-credentials

  python-sqlalchemy:
    needs: changes
    if: needs.changes.outputs.python-sqlalchemy == 'true'
    uses: ./.github/workflows/python-sqlalchemy-ci.yml
    secrets: inherit
    permissions:
      id-token: write # required by aws-actions/configure-aws-credentials

  python-tortoise:
    needs: changes
    if: needs.changes.outputs.python-tortoise == 'true'
    uses: ./.github/workflows/python-tortoise-ci.yml
    secrets: inherit
    permissions:
      id-token: write # required by aws-actions/configure-aws-credentials

  gate:
    name: gate
    runs-on: ubuntu-latest
    needs:
      - pre-commit
      - java-hibernate
      - python-django
      - python-sqlalchemy
      - python-tortoise
      - node-prisma
    if: always()
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const needs = ${{ toJSON(needs) }};
            for (const [job, result] of Object.entries(needs)) {
              if (result.result === 'failure' || result.result === 'cancelled') {
                core.setFailed(`Job ${job} ${result.result}`);
              }
            }
