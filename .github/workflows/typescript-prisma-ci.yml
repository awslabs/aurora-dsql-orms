name: TypeScript Prisma CI

permissions: {}

on:
  push:
    branches: [main]
    paths:
      - "typescript/prisma/**"
      - ".github/workflows/typescript-prisma-ci.yml"
      - ".github/workflows/dsql-cluster-*.yml"
  pull_request:
    branches: [main]
    paths:
      - "typescript/prisma/**"
      - ".github/workflows/typescript-prisma-ci.yml"
      - ".github/workflows/dsql-cluster-*.yml"
  workflow_dispatch:

defaults:
  run:
    working-directory: typescript/prisma

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Node
        uses: actions/setup-node@v6
        with:
          node-version: "22.x"

      - name: Install dependencies
        run: npm ci

      - name: Check formatting
        run: npm run format:check

      - name: Build package
        run: npm run build

  create-cluster:
    needs: build
    uses: ./.github/workflows/dsql-cluster-create.yml
    with:
      workflow_name: typescript-prisma
    secrets:
      IAM_ROLE: ${{ secrets.IAM_ROLE }}
    permissions:
      id-token: write

  test:
    needs: create-cluster
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    env:
      SSL_CERT_FILE: /tmp/AmazonRootCA1.pem

    steps:
      - uses: actions/checkout@v6

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.IAM_ROLE }}
          aws-region: ${{ needs.create-cluster.outputs.region }}

      - name: Set up Node
        uses: actions/setup-node@v6
        with:
          node-version: "22.x"

      - name: Install dependencies
        run: npm ci

      - name: Build package
        run: npm run build

      - name: Download Amazon Root Cert for SSL
        run: wget -O "$SSL_CERT_FILE" https://www.amazontrust.com/repository/AmazonRootCA1.pem

      - name: Run validator unit tests
        env:
          CLUSTER_ENDPOINT: ${{ needs.create-cluster.outputs.cluster-endpoint }}
        run: npm run test -- --testPathPattern=validate

      - name: Run transformer unit tests
        env:
          CLUSTER_ENDPOINT: ${{ needs.create-cluster.outputs.cluster-endpoint }}
        run: npm run test -- --testPathPattern=transform

      - name: Run workflow unit tests
        env:
          CLUSTER_ENDPOINT: ${{ needs.create-cluster.outputs.cluster-endpoint }}
        run: npm run test -- --testPathPattern=workflow

      - name: Run CLI integration tests
        env:
          CLUSTER_ENDPOINT: ${{ needs.create-cluster.outputs.cluster-endpoint }}
        run: npm run test -- --testPathPattern=cli-integration

  test-example:
    needs: create-cluster
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    env:
      SSL_CERT_FILE: /tmp/AmazonRootCA1.pem

    steps:
      - uses: actions/checkout@v6

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.IAM_ROLE }}
          aws-region: ${{ needs.create-cluster.outputs.region }}

      - name: Set up Node
        uses: actions/setup-node@v6
        with:
          node-version: "22.x"

      - name: Download Amazon Root Cert for SSL
        run: |
          mkdir -p ~/.postgresql
          wget https://www.amazontrust.com/repository/AmazonRootCA1.pem -O ~/.postgresql/root.crt

      - name: Install example dependencies
        working-directory: typescript/prisma/examples/veterinary-app
        run: npm ci

      - name: Build example
        working-directory: typescript/prisma/examples/veterinary-app
        env:
          CLUSTER_ENDPOINT: ${{ needs.create-cluster.outputs.cluster-endpoint }}
        run: npm run build

      - name: Run migrations as admin
        working-directory: typescript/prisma/examples/veterinary-app
        env:
          CLUSTER_USER: "admin"
          CLUSTER_ENDPOINT: ${{ needs.create-cluster.outputs.cluster-endpoint }}
        run: |
          npm run prisma:migrate-down || true
          npm run prisma:migrate-up

      - name: Run example integration tests
        working-directory: typescript/prisma/examples/veterinary-app
        env:
          CLUSTER_USER: "admin"
          CLUSTER_ENDPOINT: ${{ needs.create-cluster.outputs.cluster-endpoint }}
        run: npm run test -- --testPathPattern=dsql-client

      - name: Run sample
        working-directory: typescript/prisma/examples/veterinary-app
        env:
          CLUSTER_USER: "admin"
          CLUSTER_ENDPOINT: ${{ needs.create-cluster.outputs.cluster-endpoint }}
        run: npm run sample

      - name: Clean up migrations
        working-directory: typescript/prisma/examples/veterinary-app
        env:
          CLUSTER_USER: "admin"
          CLUSTER_ENDPOINT: ${{ needs.create-cluster.outputs.cluster-endpoint }}
        run: npm run prisma:migrate-down

  delete-cluster:
    if: always() && needs.create-cluster.result == 'success'
    needs: [create-cluster, test, test-example]
    uses: ./.github/workflows/dsql-cluster-delete.yml
    with:
      cluster-id: ${{ needs.create-cluster.outputs.cluster-id }}
      region: ${{ needs.create-cluster.outputs.region }}
    secrets:
      IAM_ROLE: ${{ secrets.IAM_ROLE }}
    permissions:
      id-token: write
